# m3u8_bypass

## これは何？

Adobe HTTP Live Streaming(HLS) のm3u8ファイルを書き換えて、tsファイルを個々にダウンロードした後に結合するスクリプトです。

## 詳細

まずは指定された```.m3u8```ファイルの記述に沿って```*.ts```ファイルをダウンロードします。その後```.m3u8```ファイルを複製・改変し、それを用いてffmpegで結合します。

## 必要なもの

- bash
- awk
- curl
- ffmpeg

## 動作確認環境

- Linux Mint 19
- Ubuntu on Windows

## ライセンス

MITライセンス

## 使い方

### 基本

``` $ ./m3u8_bypass.sh --uri (m3u8のURL) --out (出力ファイル名) ```

### オプション

``` --uri ``` または ``` --url ```

m3u8ファイルのURIを指定します。

``` --out ``` または ``` -o ```

出力ファイル名を指定します。

``` --resume ``` または ``` -r ```

開始位置を指定します。中断した際やエラーが出た際に途中から再開することが来ます。

``` --temp ``` または ``` -t ```

一時ファイルを作成するディレクトリを指定します。

``` --origin ```

Originヘッダを指定します。

``` --referer ```

リファラーを指定します。

## その他

### ffmpeg -i foo.m3u8 じゃダメなの？

それができない場合の使用を想定しています。

### ffmpeg -f concat じゃダメなの？

```*.ts```をそのまま結合するとノイズが入ることがあります。そもそもそれが嫌でこのスクリプトを書きました。単純に連結するよりも、\#EXTINFの情報を活かすことで再現性を上げます。

### 変換したm3u8から再生できる？

```ffplay```で動作を確認。選択肢で一時ファイルなどを削除しないようにすると変換された```.m3u8```ファイルが残ります。

### 劣化する？

警告が出ることがありますが、再圧縮はしておりませんので概ね劣化しないはず。それでも気になる場合は```.m3u8```から再生してください。


### 制限

- 今のところクライアントはWindows版のFirefoxに見せかけています。
- httpで始まる行をTSファイルだと認識していますが万能では無いかもしれません。
- resumeオプションで再開するときは単に指定した行数を読み飛ばします。m3m8の記述方法によっては不完全かもしれません。
