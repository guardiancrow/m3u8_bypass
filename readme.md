# m3u8_bypass

## これは何？

Adobe HTTP Live Streaming(HLS) のm3u8ファイルを書き換えて、tsファイルを個々にダウンロードした後に結合するスクリプトです。

## 詳細

まずは指定された```.m3u8```ファイルの記述に沿って```*.ts```ファイルをダウンロードします。その後```.m3u8```ファイルを複製・改変し、それを用いてffmpegで結合します。

## 必要なもの

- bash
- awk
- curl
- ffmpeg

## 動作確認環境

- Linux Mint 19
- Ubuntu on Windows

## ライセンス

MITライセンス

## 使い方

### 基本

``` $ ./m3u8_bypass.sh --uri (m3u8のURL) --out (出力ファイル名) ```

### オプション

``` --uri (m3u8のURL)``` または ``` --url (m3u8のURL)```

m3u8ファイルのURIを指定します。

``` --out (出力ファイル名)``` または ``` -o (出力ファイル名)```

出力ファイル名を指定します。

``` --resume (再開する連番番号)``` または ``` -r (再開する連番番号)```

開始位置を指定します。中断した際やエラーが出た際に途中から再開することができます。

``` --temp (一時ファイルの出力ディレクトリ名)``` または ``` -t (一時ファイルの出力ディレクトリ名)```

一時ファイルを作成するディレクトリを指定します。

``` --origin (ドメイン名)```

Originヘッダを指定します。

``` --referer (リファラーのURI)```

リファラーを指定します。

``` --append-prefix ``` または  ``` -p ```

tsファイルの衝突を防ぐために接頭語をつけます。

``` --prefix-number (接頭語の文字列)``` または ``` -pn (接頭語の文字列)```

接頭語をつけるときに接頭語を指定します。``` --append-prefix ```が指定されていて、このオプションが無い場合はランダムな数字の接頭語がつきます。```--resume```で再開したときに、ランダムな接尾語がつくと意味が無いのでこのオプションで指定します。

``` --skip-if-exist ``` または ``` -s ```

再開時に既にtsファイルがある場合は上書きせずにスキップします。

``` --check-files ``` または ``` -c ```

tsファイル取得後、結合前にファイルをチェックをします。ファイルが足りない場合はパッチ処理を終了します。```--resume``` や ``` --skip-if-exist ``` オプションをつけて再開することができます。

### レジューム機能の補足

強化されたレジューム機能を使用する例は、

初回は、

``` $ ./m3u8_bypass.sh --uri (m3u8のURL) --out (出力ファイル名) --append-prefix --skip-if-exist --check-files```

とし、二回目以降、

``` $ ./m3u8_bypass.sh --uri (m3u8のURL) --out (出力ファイル名) --append-prefix --prefix-number (前回の接頭語 例：12345) --skip-if-exist --check-files```

とします。

+ 初回に``` --append-prefix ```で付与される接頭語番号を二回目以降の``` --prefix-number```オプションで指定してください。
+ ``` --skip-if-exist ```を指定しておけばファイルの上書きがされないので``` --resume ```は要りません。
+ 但し、ファイルの中身まではチェックされないことに注意してください。不意なダウンロードエラーなどの場合は連番最後のファイルを手動削除してから再開した方が良いかもです。

### 接頭語をつける意味

このスクリプトは単純にm3u8のファイル名を一時ファイル名として使っているため、例えば、```video.m3u8```のような単純なファイル名の場合は、```video```ディレクトリにどんどん上書きされてしまうことが想定されます。それを防ぐために乱数をあてがい、```12345-video```のようなディレクトリ名にして衝突を防ぎます。（簡単なハッシュですのでそれでも衝突するかもしれません）

もちろんこれはレジューム機能にも影響しますので再開するする場合は``` --prefix-number```で初回に設定された接頭語を指定してください。

## その他

### ffmpeg -i foo.m3u8 じゃダメなの？

それができない場合の使用を想定しています。

### ffmpeg -f concat じゃダメなの？

```*.ts```をそのまま結合するとノイズが入ることがあります。そもそもそれが嫌でこのスクリプトを書きました。単純に連結するよりも、\#EXTINFの情報を活かすことで再現性を上げます。

### 変換したm3u8から再生できる？

```ffplay```で動作を確認。選択肢で一時ファイルなどを削除しないようにすると変換された```.m3u8```ファイルが残ります。

### 劣化する？

警告が出ることがありますが、再圧縮はしておりませんので概ね劣化しないはず。それでも気になる場合は```.m3u8```から再生してください。


### 制限

- 今のところクライアントはWindows版のFirefoxに見せかけています。
- httpで始まる行をTSファイルだと認識していますが万能では無いかもしれません。
- resumeオプションで再開するときは単に指定した行数を読み飛ばします。m3m8の記述方法によっては不完全かもしれません。
- 性質上、悪用できる可能性があります。違法なことに使用しないでください。
